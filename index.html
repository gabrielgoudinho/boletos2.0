<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Boletos</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f6fa; color: #333; }

    header {
      background: #2c3e50;
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 { font-size: 20px; }
    #logout {
      cursor: pointer;
      font-weight: bold;
      color: #f39c12;
      text-decoration: none;
    }

    #app {
      max-width: 1100px;
      margin: 20px auto;
      padding: 10px;
    }

    nav {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    nav button {
      flex: 1;
      min-width: 140px;
      padding: 10px;
      border: none;
      background: #3498db;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    nav button:hover { background: #2980b9; }

    .cards {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .card {
      flex: 1;
      min-width: 200px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    .card h3 { font-size: 16px; margin-bottom: 10px; }
    .card span { font-size: 24px; font-weight: bold; color: #2c3e50; }

    .page {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow-x: auto; /* scroll horizontal em tabelas no mobile */
    }

    table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 14px; min-width: 600px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #34495e; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #f1f1f1; }

    #login {
      max-width: 350px;
      margin: 100px auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #login h2 { margin-bottom: 15px; text-align: center; }
    #login input {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #login button {
      width: 100%;
      padding: 10px;
      background: #27ae60;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    #login button:hover { background: #1e8449; }

    #loginError { margin-top: 10px; }
    #errorBox { color: red; margin-top: 20px; }

    /* ===== RESPONSIVIDADE ===== */
    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; gap: 10px; }
      nav { flex-direction: column; }
      nav button { width: 100%; }
      .cards { flex-direction: column; }
      .card { width: 100%; }
      table { font-size: 13px; }
    }

    @media (max-width: 480px) {
      header h1 { font-size: 18px; }
      .card h3 { font-size: 14px; }
      .card span { font-size: 20px; }
      th, td { padding: 8px; font-size: 12px; }
    }
  </style>
</head>
<body>

  <div id="login">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="UsuÃ¡rio" />
    <input type="password" id="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="app" style="display:none;">
    <header>
      <h1>Sistema de Boletos</h1>
      <div>
        <span id="userNameDisplay"></span> (<span id="userRole"></span>) | 
        <a id="logout" onclick="logout()">Sair</a>
      </div>
    </header>

    <nav>
      <button onclick="showPage('boletos')">ðŸ“„ Boletos em Aberto</button>
      <button onclick="showPage('producao')">ðŸ“Š ProduÃ§Ã£o Mensal</button>
    </nav>

    <div class="cards">
      <div class="card">
        <h3>Base Ativa</h3>
        <span id="baseAtiva">0</span>
      </div>
      <div class="card">
        <h3>Boletos em Aberto</h3>
        <span id="boletosAberto">0</span>
      </div>
      <div class="card">
        <h3>Total ProduÃ§Ã£o</h3>
        <span id="totalProducao">0</span>
      </div>
    </div>

    <div id="boletos" class="page">
      <h3>Lista de Boletos</h3>
      <table id="boletosTable">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Placa</th>
            <th>VoluntÃ¡rio</th>
            <th>Data Contrato</th>
            <th>Status</th>
            <th>Link do Boleto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="producao" class="page" style="display:none;">
      <h3>ProduÃ§Ã£o do MÃªs</h3>
      <table id="producaoTable">
        <thead>
          <tr>
            <th>VoluntÃ¡rio</th>
            <th>Produziu</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="errorBox"></div>
  </div>

<script>
  const users = {
    "gabriel clubbea": { password: "123456", role: "gestor" },
    "rodger": { password: "123456", role: "voluntario" },
  };

  let currentUser = null;
  let sheetData = [];

  function login() {
    const userInput = document.getElementById('username').value.trim().toLowerCase();
    const passInput = document.getElementById('password').value;
    const errorEl = document.getElementById('loginError');

    if (users[userInput] && users[userInput].password === passInput) {
      currentUser = { name: userInput, role: users[userInput].role };
      document.getElementById('login').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('userNameDisplay').textContent = userInput;
      document.getElementById('userRole').textContent = users[userInput].role;
      loadSheetData();
    } else {
      errorEl.textContent = 'UsuÃ¡rio ou senha invÃ¡lidos!';
    }
  }

  function logout() {
    currentUser = null;
    sheetData = [];
    document.getElementById('login').style.display = 'block';
    document.getElementById('app').style.display = 'none';
    document.getElementById('loginError').textContent = '';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }

  function showPage(page) {
    document.querySelectorAll('.page').forEach(div => div.style.display = 'none');
    document.getElementById(page).style.display = 'block';
  }

  const sheetId = '1dEqBfpPAyIG8h9GjYhrvMz08AYBnu3qa2ZvVVy_Fl_k';
  const queryUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

  async function loadSheetData() {
    const errorBox = document.getElementById('errorBox');
    errorBox.textContent = '';

    try {
      const res = await fetch(queryUrl);
      const text = await res.text();

      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      if (text.includes('"status":"error"') || text.toLowerCase().includes('access_denied')) {
        throw new Error('Acesso negado ou erro ao acessar planilha');
      }

      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start < 0 || end < 0) throw new Error('Formato do JSON invÃ¡lido');

      const jsonText = text.substring(start, end + 1);
      const data = JSON.parse(jsonText);

      if (!data.table || !data.table.rows) throw new Error('JSON nÃ£o contÃ©m dados esperados');

      sheetData = data.table.rows.map(row => {
        return {
          nome: row.c[0]?.v || '',
          placa: row.c[1]?.v || '',
          status: row.c[2]?.v || '',
          voluntario: row.c[3]?.v || '',
          dataContrato: row.c[4]?.f || row.c[4]?.v || '',
          linkBoleto: row.c[5]?.v || ''
        };
      });

      renderBoletos();
      renderProducao();
    } catch (e) {
      console.error('Erro no loadSheetData:', e);
      errorBox.textContent = 'Erro ao carregar dados: ' + e.message;
    }
  }

  function renderBoletos() {
    let filtrados = currentUser.role === 'gestor'
      ? sheetData
      : sheetData.filter(item => item.voluntario.toLowerCase() === currentUser.name);

    const baseAtiva = new Set(filtrados.map(item => item.nome.trim())).size;
    const boletosAberto = filtrados.filter(item => (item.status || '').toLowerCase() === 'aberto').length;

    document.getElementById('baseAtiva').textContent = baseAtiva;
    document.getElementById('boletosAberto').textContent = boletosAberto;

    const tbody = document.querySelector('#boletosTable tbody');
    tbody.innerHTML = '';

    filtrados.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nome}</td>
        <td>${item.placa}</td>
        <td>${item.voluntario}</td>
        <td>${item.dataContrato}</td>
        <td>${item.status}</td>
        <td>${item.linkBoleto ? `<a href="${item.linkBoleto}" target="_blank">ðŸ”— Boleto</a>` : ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderProducao() {
    const abertos = sheetData.filter(item => (item.status || '').toLowerCase() === 'aberto');

    let filtrados = currentUser.role === 'gestor'
      ? abertos
      : abertos.filter(item => item.voluntario.toLowerCase() === currentUser.name);

    const producaoMap = {};
    filtrados.forEach(item => {
      if(item.voluntario) {
        const v = item.voluntario.trim();
        producaoMap[v] = (producaoMap[v] || 0) + 1;
      }
    });

    const tbody = document.querySelector('#producaoTable tbody');
    tbody.innerHTML = '';
    let total = 0;

    for (const [vol, count] of Object.entries(producaoMap)) {
      total += count;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${vol}</td><td>${count}</td>`;
      tbody.appendChild(tr);
    }

    document.getElementById('totalProducao').textContent = total;
  }
</script>

</body>
</html>
